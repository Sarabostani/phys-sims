<!DOCTYPE html>
<html>
<head>
<title>Newton Cannon</title>
<link rel="stylesheet" type="text/css" href="../style.css" />
<style>
#zoomin{
	width:30px;
	position:absolute;
	left:865px;
	top:.5em;
}
#zoomout{
	width:30px;
	position:absolute;
	left:865px;
	top:2.5em;
}
#start{
	position:absolute;
	left:850px;
	top:4.5em;
}
#reset{
	position:absolute;
	left:845px;
	top:6.5em;
}
</style>
</head>

<body>
<img id="earth" src="earth.png" style="width:500px;visibility:hidden;display:none" width="500px" />
<img id="mountain" src="mountain.png" style="width:500px;visibility:hidden;display:none" />
<div id="container">
	<input id="zoomin" type="button" value="+" />
	<input id="zoomout" type="button" value="-" />
	<input id="start" type="button" value="Start" />
	<input id="reset" type="button" value="Reset" />
	<canvas width="900" height="500" id="canvas">Your browser doesn't support canvas.</canvas>
</div>
<label id="alpha"></label>


<script src="../lib/utils.js"></script>
<script src="../lib/ball.js"></script>

<script>

/****************************
* INITIALIZING VALUES AND VARIABLES
******************************/

var earth = {
	radius : 200,
	center : new Point(450,250)
};

var ball = new Ball('red',0.5);

var earthImg = document.getElementById("earth");
var mountain = document.getElementById("mountain");

var trace = new Array();

var animating = false;
var reqAnimID = null;

function initValues(){

	ball.x = earth.center.x - 14; 
	ball.y = earth.center.y - earth.radius - ball.radius - 16;

	ball.vx = 1.4;	
	ball.vy = 0;
	ball.ax = 0;
	ball.ay = 0;
	
	trace = new Array();
	animating = false;
	adjustBallAcceleration();
	reqAnimID = null;
}


document.getElementById('zoomin').addEventListener('click',zoomIn);
document.getElementById('zoomout').addEventListener('click',zoomOut);
document.getElementById('start').addEventListener('click',start);
document.getElementById('reset').addEventListener('click',reset);

/********************
* HANDLING ZOOM
*********************/
var zoomPoint = new Point(earth.center.x + 20, earth.center.y - earth.radius - 20);
var scaleFactor = 1.8;
var zoomLimit = 1;

function zoomIn(){
	if(zoomLimit < 6){
		zoomToPoint(zoomPoint,scaleFactor,'in');
		++zoomLimit;	
	}
}
function zoomOut(){
	if(zoomLimit > 1){
		zoomToPoint(zoomPoint,scaleFactor,'out');
		--zoomLimit;		
	}
}

/*****************************
* ANIMATION START/STOP/RESET
******************************/

window.onload = function(){
	initValues();
	paint();
	//console.log(distance(ball.center,earth.center));
};


function start(){
	if(!reqAnimID){
		animating = true;
		startAnimation();
	}
}
function startAnimation(){
	reqAnimID = reqAnimFrame(startAnimation);	
	paint();
}

function stopAnimation(){
	if(reqAnimID){
		cancelAnim(reqAnimID);
		animating = false;
		console.log('stopped , #of points = ' + trace.length);
	}
}

function reset(){

	stopAnimation();
	initValues();
	paint();
}


/*******************
* MAIN PAINT FUNCTION
********************/
function paint(){

	ctx.fillStyle = '#eff';
	ctx.fillRect(0,0,can.width, can.height);
	
	//ctx.clearRect(0,0,can.width,can.height);
	//drawing the earth. Images are drawn from upper left corner
	ctx.drawImage(earthImg,earth.center.x - earth.radius,earth.center.y - earth.radius, earth.radius*2, earth.radius*2);
	ctx.drawImage(mountain,425,earth.center.y - earth.radius - 16,20,20);
	
	if(animating){
		adjustBallAcceleration();		
		ball.updatePosition();	
		trace.push(new Point(ball.x,ball.y));
	}
	
	ball.draw();
	
	trace.forEach(function(pt){
		ctx.save();
		ctx.fillStyle = 'red';
		ctx.fillRect(pt.x,pt.y,0.51,0.51);
		ctx.restore();
	});
	
	
	if((distance(ball.center,earth.center) < earth.radius || ball.outOfCanvas() ) && animating == true){
		stopAnimation();
	}
}

/**************
* CALCULATIONS
***************/
var alpha = 0.0;
var acceleration = 0.02;
var alphalable = document.getElementById("alpha");
function adjustBallAcceleration(){
	alpha = angleBetween(ball.center, earth.center);
	ball.ax = Math.cos(alpha)*acceleration;
	ball.ay = Math.sin(alpha)*acceleration;
	alphalable.innerHTML = alpha*180/(Math.PI) + "<br>" + ball.ax;
}






/********
* Mouse scroll not used
*********/
lowZoom = 0;
highZoom = 30;
var delta = 1.0;
function handleScroll(evt){

	delta = evt.wheelDelta ? evt.wheelDelta/40 : evt.detail ? -evt.detail : 0;
	
	if(delta < 0 && zoomLimit > lowZoom)
		--zoomLimit;
	else if(delta > 0 && zoomLimit < highZoom)
		++zoomLimit;
	
	if( zoomLimit > lowZoom && zoomLimit < highZoom){
		if (delta) zoomToPoint(delta, point);
		paint();
	}
}

</script>

</body>
</html>

